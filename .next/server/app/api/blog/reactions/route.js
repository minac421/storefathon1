(()=>{var e={};e.id=5251,e.ids=[5251],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},5069:(e,t,r)=>{"use strict";r.d(t,{kR:()=>l});var n=r(56037),o=r.n(n);let s=process.env.MONGODB_URI||"mongodb://localhost:27017/conquerors-website";s||console.warn("تحذير: تأكد من تعيين متغير البيئة MONGODB_URI في ملف .env أو .env.local");let i={isConnected:!1},a=async()=>{if(i.isConnected)return void console.log("\uD83C\uDF10 استخدام اتصال موجود بقاعدة البيانات");try{let e=await o().connect(s);i.isConnected=1===e.connections[0].readyState,console.log("✅ تم الاتصال بقاعدة البيانات MongoDB بنجاح")}catch(e){throw console.error("❌ خطأ في الاتصال بقاعدة البيانات:",e),Error("فشل الاتصال بقاعدة البيانات")}},l=async e=>(await a(),await e())},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},17278:(e,t,r)=>{"use strict";r.d(t,{A:()=>u});var n=r(56037),o=r.n(n),s=r(99493);let i=new(o()).Schema({author:{userId:{type:String,default:null},name:{type:String,required:[!0,"الرجاء إدخال اسم المعلق"]},avatar:{type:String,default:null}},content:{type:String,required:[!0,"الرجاء إدخال نص التعليق"],trim:!0,maxlength:[500,"يجب ألا يزيد التعليق عن 500 حرف"]},likes:[{type:String}],replies:[{author:{userId:{type:String,default:null},name:{type:String,required:!0},avatar:{type:String,default:null}},content:{type:String,required:!0,trim:!0,maxlength:[300,"يجب ألا يزيد الرد عن 300 حرف"]},likes:[{type:String}],createdAt:{type:Date,default:Date.now}}],isApproved:{type:Boolean,default:!0},createdAt:{type:Date,default:Date.now}},{timestamps:!0}),a=new(o()).Schema({userId:{type:String,default:null},name:{type:String,required:!0},avatar:{type:String,default:null},bio:{type:String,default:""},contactInfo:{type:String,default:null},isFeatured:{type:Boolean,default:!1},isVerified:{type:Boolean,default:!1}}),l=new(o()).Schema({title:{type:String,required:[!0,"الرجاء إدخال عنوان المقال"],trim:!0,maxlength:[100,"يجب ألا يزيد العنوان عن 100 حرف"]},slug:{type:String,required:!0,unique:!0,trim:!0},content:{type:String,required:[!0,"الرجاء إدخال محتوى المقال"]},summary:{type:String,required:[!0,"الرجاء إدخال ملخص المقال"],maxlength:[300,"يجب ألا يزيد الملخص عن 300 حرف"]},category:{type:String,required:[!0,"الرجاء اختيار فئة المقال"],enum:Object.values(s.P),default:s.P.NEWS},author:a,featuredImage:{type:String,default:null},media:{images:[{type:String}],videos:[{url:{type:String},thumbnail:{type:String,default:null},title:{type:String,default:""},duration:{type:Number,default:0}}]},interaction:{likes:[{type:String}],shares:{type:Number,default:0},bookmarks:[{type:String}],views:{type:Number,default:0},reactions:{fire:[{type:String}],shield:[{type:String}],crown:[{type:String}],castle:[{type:String}],laugh:[{type:String}]}},comments:[i],tags:[{type:String,trim:!0}],isFeatured:{type:Boolean,default:!1},isPinned:{type:Boolean,default:!1},isPublished:{type:Boolean,default:!0},needsReview:{type:Boolean,default:!0},createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now},publishedAt:{type:Date,default:null}},{timestamps:!0});l.index({title:"text",content:"text",tags:"text"});let u=o().models.BlogPost||o().model("BlogPost",l)},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},56037:e=>{"use strict";e.exports=require("mongoose")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},69729:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>R,routeModule:()=>m,serverHooks:()=>h,workAsyncStorage:()=>w,workUnitAsyncStorage:()=>x});var n={};r.r(n),r.d(n,{GET:()=>f,POST:()=>S});var o=r(96559),s=r(48088),i=r(37719),a=r(32190),l=r(99493),u=r(5069),c=r(17278),d=r(56037),p=r.n(d);let g=new(p()).Schema({postId:{type:String,required:!0},type:{type:String,required:!0,enum:Object.values(l.o)},sessionId:{type:String,required:!0},nickname:{type:String,default:"زائر"},timestamp:{type:Date,default:Date.now}}),y=p().models.Reaction||p().model("Reaction",g);async function f(e){let{searchParams:t}=new URL(e.url),r=t.get("postId");if(!r)return a.NextResponse.json({error:"معرّف المنشور مطلوب"},{status:400});try{return await (0,u.kR)(async()=>{try{let e=await y.find({postId:r}).lean().exec();if(!await c.A.findById(r).exec())return a.NextResponse.json({error:"المنشور غير موجود"},{status:404});let t={[l.o.SWORD]:0,[l.o.FIRE]:0,[l.o.SHIELD]:0,[l.o.CROWN]:0,[l.o.CASTLE]:0,[l.o.LAUGH]:0,total:e.length};return e.forEach(e=>{t[e.type]=(t[e.type]||0)+1}),a.NextResponse.json({success:!0,reactions:e,counts:t})}catch(e){return console.error("Error fetching reactions:",e),a.NextResponse.json({error:"حدث خطأ أثناء جلب التفاعلات"},{status:500})}})}catch(e){return console.error("Database connection error:",e),a.NextResponse.json({error:"حدث خطأ في الاتصال بقاعدة البيانات"},{status:500})}}async function S(e){try{return await (0,u.kR)(async()=>{try{console.log("Received reaction POST request");let t=await e.json();console.log("Request body:",t);let{postId:r,type:n,sessionId:o,nickname:s}=t;if(!r)return console.error("Missing postId field"),a.NextResponse.json({error:"معرّف المنشور مطلوب"},{status:400});if(!n)return console.error("Missing type field"),a.NextResponse.json({error:"نوع التفاعل مطلوب"},{status:400});if(!o)return console.error("Missing sessionId field"),a.NextResponse.json({error:"معرّف الجلسة مطلوب"},{status:400});let i=["sword","fire","shield","crown","castle","laugh"];if(!i.includes(String(n)))return console.error("Invalid reaction type:",n),a.NextResponse.json({error:`نوع التفاعل غير صالح: ${n}. الأنواع المسموح بها: ${i.join(", ")}`},{status:400});let u=await c.A.findById(r).exec();if(!u)return console.error("Post not found:",r),a.NextResponse.json({error:"المنشور غير موجود"},{status:404});let d=await y.findOne({postId:r,sessionId:o,type:n}).exec(),p=!1;if(d)await y.deleteOne({_id:d._id}),p=!1;else{let e={postId:r,type:n,sessionId:o,nickname:s||"زائر",timestamp:new Date},t=new y(e);await t.save(),p=!0}if(u.interaction||(u.interaction={likes:[],shares:0,bookmarks:[],views:0}),"sword"===n){u.interaction.likes||(u.interaction.likes=[]);let e=u.interaction.likes.indexOf(o);p&&-1===e?u.interaction.likes.push(o):p||-1===e||u.interaction.likes.splice(e,1)}else{u.interaction.reactions||(u.interaction.reactions={fire:[],shield:[],crown:[],castle:[],laugh:[]}),u.interaction.reactions[n]||(u.interaction.reactions[n]=[]);let e=u.interaction.reactions[n],t=e.indexOf(o);p&&-1===t?e.push(o):p||-1===t||e.splice(t,1)}await u.save();let g=await y.find({postId:r}).lean().exec(),f={[l.o.SWORD]:0,[l.o.FIRE]:0,[l.o.SHIELD]:0,[l.o.CROWN]:0,[l.o.CASTLE]:0,[l.o.LAUGH]:0,total:g.length};return g.forEach(e=>{f[e.type]=(f[e.type]||0)+1}),a.NextResponse.json({success:!0,added:p,reactions:g,counts:f})}catch(e){return console.error("Error handling reaction:",e),a.NextResponse.json({error:"حدث خطأ أثناء معالجة التفاعل"},{status:500})}})}catch(e){return console.error("Database connection error:",e),a.NextResponse.json({error:"حدث خطأ في الاتصال بقاعدة البيانات"},{status:500})}}let m=new o.AppRouteRouteModule({definition:{kind:s.RouteKind.APP_ROUTE,page:"/api/blog/reactions/route",pathname:"/api/blog/reactions",filename:"route",bundlePath:"app/api/blog/reactions/route"},resolvedPagePath:"C:\\Users\\minaa\\CascadeProjects\\conquerors-website\\src\\app\\api\\blog\\reactions\\route.ts",nextConfigOutput:"",userland:n}),{workAsyncStorage:w,workUnitAsyncStorage:x,serverHooks:h}=m;function R(){return(0,i.patchFetch)({workAsyncStorage:w,workUnitAsyncStorage:x})}},78335:()=>{},96487:()=>{},99493:(e,t,r)=>{"use strict";r.d(t,{P:()=>n,o:()=>o});var n=function(e){return e.GUIDE="guide",e.NEWS="news",e.TIPS="tips",e.ANALYSIS="analysis",e.MARKET="market",e.MEMES="memes",e.EXPERIENCE="experience",e}({}),o=function(e){return e.SWORD="sword",e.FIRE="fire",e.SHIELD="shield",e.CROWN="crown",e.CASTLE="castle",e.LAUGH="laugh",e}({})}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[7719,580],()=>r(69729));module.exports=n})();