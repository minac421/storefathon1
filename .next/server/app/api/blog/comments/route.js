(()=>{var e={};e.id=1967,e.ids=[1967],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},5069:(e,t,r)=>{"use strict";r.d(t,{kR:()=>c});var s=r(56037),n=r.n(s);let o=process.env.MONGODB_URI||"mongodb://localhost:27017/conquerors-website";o||console.warn("تحذير: تأكد من تعيين متغير البيئة MONGODB_URI في ملف .env أو .env.local");let a={isConnected:!1},i=async()=>{if(a.isConnected)return void console.log("\uD83C\uDF10 استخدام اتصال موجود بقاعدة البيانات");try{let e=await n().connect(o);a.isConnected=1===e.connections[0].readyState,console.log("✅ تم الاتصال بقاعدة البيانات MongoDB بنجاح")}catch(e){throw console.error("❌ خطأ في الاتصال بقاعدة البيانات:",e),Error("فشل الاتصال بقاعدة البيانات")}},c=async e=>(await i(),await e())},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},17278:(e,t,r)=>{"use strict";r.d(t,{A:()=>u});var s=r(56037),n=r.n(s),o=r(99493);let a=new(n()).Schema({author:{userId:{type:String,default:null},name:{type:String,required:[!0,"الرجاء إدخال اسم المعلق"]},avatar:{type:String,default:null}},content:{type:String,required:[!0,"الرجاء إدخال نص التعليق"],trim:!0,maxlength:[500,"يجب ألا يزيد التعليق عن 500 حرف"]},likes:[{type:String}],replies:[{author:{userId:{type:String,default:null},name:{type:String,required:!0},avatar:{type:String,default:null}},content:{type:String,required:!0,trim:!0,maxlength:[300,"يجب ألا يزيد الرد عن 300 حرف"]},likes:[{type:String}],createdAt:{type:Date,default:Date.now}}],isApproved:{type:Boolean,default:!0},createdAt:{type:Date,default:Date.now}},{timestamps:!0}),i=new(n()).Schema({userId:{type:String,default:null},name:{type:String,required:!0},avatar:{type:String,default:null},bio:{type:String,default:""},contactInfo:{type:String,default:null},isFeatured:{type:Boolean,default:!1},isVerified:{type:Boolean,default:!1}}),c=new(n()).Schema({title:{type:String,required:[!0,"الرجاء إدخال عنوان المقال"],trim:!0,maxlength:[100,"يجب ألا يزيد العنوان عن 100 حرف"]},slug:{type:String,required:!0,unique:!0,trim:!0},content:{type:String,required:[!0,"الرجاء إدخال محتوى المقال"]},summary:{type:String,required:[!0,"الرجاء إدخال ملخص المقال"],maxlength:[300,"يجب ألا يزيد الملخص عن 300 حرف"]},category:{type:String,required:[!0,"الرجاء اختيار فئة المقال"],enum:Object.values(o.P),default:o.P.NEWS},author:i,featuredImage:{type:String,default:null},media:{images:[{type:String}],videos:[{url:{type:String},thumbnail:{type:String,default:null},title:{type:String,default:""},duration:{type:Number,default:0}}]},interaction:{likes:[{type:String}],shares:{type:Number,default:0},bookmarks:[{type:String}],views:{type:Number,default:0},reactions:{fire:[{type:String}],shield:[{type:String}],crown:[{type:String}],castle:[{type:String}],laugh:[{type:String}]}},comments:[a],tags:[{type:String,trim:!0}],isFeatured:{type:Boolean,default:!1},isPinned:{type:Boolean,default:!1},isPublished:{type:Boolean,default:!0},needsReview:{type:Boolean,default:!0},createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now},publishedAt:{type:Date,default:null}},{timestamps:!0});c.index({title:"text",content:"text",tags:"text"});let u=n().models.BlogPost||n().model("BlogPost",c)},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},56037:e=>{"use strict";e.exports=require("mongoose")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},63145:(e,t,r)=>{"use strict";let s;r.r(t),r.d(t,{patchFetch:()=>j,routeModule:()=>w,serverHooks:()=>A,workAsyncStorage:()=>x,workUnitAsyncStorage:()=>v});var n={};r.r(n),r.d(n,{GET:()=>h,POST:()=>S});var o=r(96559),a=r(48088),i=r(37719),c=r(32190),u=r(5069),l=r(56037),d=r.n(l),p=r(17278),g=r(74762);let m=new(d()).Schema({text:{type:String,required:!0},author:{type:String,required:!0},authorAvatarId:{type:Number},postId:{type:String,required:!0},createdAt:{type:Date,default:Date.now}});try{s=d().model("Comment")}catch(e){s=d().model("Comment",m)}async function y(e){if(!e||"string"!=typeof e)return console.warn("تحقق من صحة المعرف: معرف المنشور غير صالح أو مفقود",{postId:e}),{valid:!1,error:"معرف المنشور غير صالح أو مفقود"};try{let t,r=!1;if(/^[0-9a-fA-F]{24}$/.test(e))try{t=new(d()).Types.ObjectId(e),r=!0}catch(t){console.warn("لا يمكن تحويل المعرف إلى ObjectId مع أنه يبدو صالحًا:",{postId:e,error:t})}else console.log("المعرف ليس بتنسيق MongoDB ObjectId، سيتم البحث بطريقة أخرى:",{postId:e});let s={$or:[]};r&&s.$or.push({_id:t}),s.$or.push({id:e}),s.$or.push({slug:e}),console.log("التحقق من المنشور باستخدام الاستعلام:",JSON.stringify(s));let n=await p.A.countDocuments(s),o=n>0;return console.log(`نتيجة التحقق من المنشور: ${o?"موجود":"غير موجود"}`,{postId:e,count:n}),{valid:o,error:o?null:"المنشور غير موجود"}}catch(e){return console.error("خطأ غير متوقع في التحقق من معرف المنشور:",e),{valid:!1,error:"خطأ في التحقق من معرف المنشور"}}}async function f(e){console.log("محاولة الحصول على التعليقات من نموذج BlogPost مباشرةً:",{postId:e});try{let t={$or:[]};if(/^[0-9a-fA-F]{24}$/.test(e))try{let r=new(d()).Types.ObjectId(e);t.$or.push({_id:r})}catch(t){console.log("تعذر تحويل المعرف إلى ObjectId:",{postId:e})}t.$or.push({id:e}),t.$or.push({slug:e}),console.log("استعلام الحصول على تعليقات المنشور:",JSON.stringify(t));let r=await p.A.findOne(t).select("comments").lean().exec();if(!r)return console.log("لم يتم العثور على المنشور:",{postId:e}),{success:!1,error:"المنشور غير موجود"};if(!r.comments||!Array.isArray(r.comments))return console.log("المنشور موجود ولكن لا توجد تعليقات:",{postId:e}),{success:!0,comments:[]};console.log(`تم العثور على ${r.comments.length} تعليق للمنشور:`,{postId:e});let s=r.comments.map(t=>({id:t._id?t._id.toString():`temp-${Date.now()}`,text:t.content,author:"object"==typeof t.author?t.author.name:t.author,authorAvatarId:t.author&&"object"==typeof t.author&&t.author.avatar&&parseInt(t.author.avatar.replace(/[^\d]/g,""))||1,createdAt:t.createdAt||new Date().toISOString(),postId:e}));return s.sort((e,t)=>new Date(t.createdAt).getTime()-new Date(e.createdAt).getTime()),{success:!0,comments:s}}catch(e){return console.error("خطأ أثناء الحصول على تعليقات المنشور مباشرة:",e),{success:!1,error:e.message||"حدث خطأ أثناء جلب تعليقات المنشور"}}}async function h(e){let t=new URL(e.url).searchParams.get("postId");if(!t)return console.warn("محاولة الوصول إلى التعليقات بدون معرف منشور"),c.NextResponse.json({success:!1,error:"معرف المنشور مطلوب"},{status:400});console.log("طلب التعليقات للمنشور:",{postId:t});try{return await (0,u.kR)(async()=>{try{let e=await f(t);if(e.success)return c.NextResponse.json(e);console.log("فشل الحصول على التعليقات من BlogPost، محاولة الطريقة البديلة");let{valid:r,error:n}=await y(t);if(!r)return console.warn(`تحذير: المنشور غير صالح: ${t}، الخطأ: ${n}`),c.NextResponse.json({success:!1,error:n||"حدث خطأ أثناء التحقق من وجود المنشور"},{status:"المنشور غير موجود"===n?404:400});console.log("جاري البحث عن تعليقات المنشور:",{postId:t});let o=await s.find().where("postId").equals(t).sort({createdAt:-1}).lean().limit(100);console.log(`تم العثور على ${o.length} تعليق للمنشور:`,{postId:t});let a=o&&o.length>0?(0,g.Xg)(o):[];return c.NextResponse.json({success:!0,comments:a})}catch(s){console.error("خطأ في جلب التعليقات:",s);let e=s instanceof Error?s.message:String(s),r=s instanceof Error?s.stack:"";return console.error("تفاصيل خطأ جلب التعليقات:",{message:e,stack:r,postId:t}),c.NextResponse.json({success:!1,error:"حدث خطأ أثناء جلب التعليقات",details:e},{status:500})}})}catch(r){console.error("خطأ في الاتصال بقاعدة البيانات:",r);let e=r instanceof Error?r.message:String(r);return console.error("تفاصيل خطأ الاتصال بقاعدة البيانات:",{message:e,stack:r instanceof Error?r.stack:"",postId:t}),c.NextResponse.json({success:!1,error:"حدث خطأ في الاتصال بقاعدة البيانات",details:e},{status:500})}}async function S(e){try{return await (0,u.kR)(async()=>{try{let{text:t,author:r,authorAvatarId:n,postId:o}=await e.json();if(!t||"string"!=typeof t)return c.NextResponse.json({success:!1,error:"يجب كتابة نص التعليق"},{status:400});if(!r||"string"!=typeof r)return c.NextResponse.json({success:!1,error:"يجب تحديد اسم المعلق"},{status:400});if(!o||"string"!=typeof o)return c.NextResponse.json({success:!1,error:"يجب تحديد معرف المنشور"},{status:400});let{valid:a,error:i}=await y(o);if(!a)return c.NextResponse.json({success:!1,error:i||"حدث خطأ أثناء التحقق من وجود المنشور"},{status:"المنشور غير موجود"===i?404:400});try{let e={$or:[]};if(/^[0-9a-fA-F]{24}$/.test(o))try{let t=new(d()).Types.ObjectId(o);e.$or.push({_id:t})}catch(e){console.log("تعذر تحويل المعرف إلى ObjectId:",{postId:o})}e.$or.push({id:o}),e.$or.push({slug:o}),console.log("استعلام إضافة تعليق للمنشور:",JSON.stringify(e));let a={author:{name:r,avatar:n?`/images/avatars/${n}.png`:"/images/avatars/default.png"},content:t,createdAt:new Date},i=await p.A.updateOne(e,{$push:{comments:a}});if(console.log("نتيجة إضافة التعليق للمنشور:",i),i.matchedCount>0)return c.NextResponse.json({success:!0,comment:{id:`temp-${Date.now()}`,text:t,author:r,authorAvatarId:n||1,createdAt:new Date().toISOString(),postId:o}});console.log("لم يتم العثور على المنشور لإضافة التعليق، جاري المحاولة بالطريقة البديلة");let u=new s({text:t,author:r,authorAvatarId:n||1,postId:o,createdAt:new Date});await u.save();let l=u.toObject(),m=(0,g.Xg)(l);return c.NextResponse.json({success:!0,comment:m})}catch(t){console.error("Error saving comment:",t);let e=t instanceof Error?t.stack:"";return console.error("تفاصيل خطأ حفظ التعليق:",{message:t.message,stack:e,postId:o}),c.NextResponse.json({success:!1,error:"حدث خطأ أثناء حفظ التعليق",details:t instanceof Error?t.message:String(t)},{status:500})}}catch(t){console.error("Error creating comment:",t);let e=t instanceof Error?t.stack:"";return console.error("تفاصيل خطأ إنشاء التعليق:",{message:t.message,stack:e}),c.NextResponse.json({success:!1,error:"حدث خطأ أثناء إنشاء التعليق",details:t instanceof Error?t.message:String(t)},{status:500})}})}catch(t){console.error("خطأ في الاتصال بقاعدة البيانات عند إضافة تعليق:",t);let e=t instanceof Error?t.stack:"";return console.error("تفاصيل خطأ الاتصال بقاعدة البيانات:",{message:t.message,stack:e}),c.NextResponse.json({success:!1,error:"حدث خطأ في الاتصال بقاعدة البيانات",details:t instanceof Error?t.message:String(t)},{status:500})}}let w=new o.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/blog/comments/route",pathname:"/api/blog/comments",filename:"route",bundlePath:"app/api/blog/comments/route"},resolvedPagePath:"C:\\Users\\minaa\\CascadeProjects\\conquerors-website\\src\\app\\api\\blog\\comments\\route.ts",nextConfigOutput:"",userland:n}),{workAsyncStorage:x,workUnitAsyncStorage:v,serverHooks:A}=w;function j(){return(0,i.patchFetch)({workAsyncStorage:x,workUnitAsyncStorage:v})}},74762:(e,t,r)=>{"use strict";async function s(e,t){return await e.findById(t).lean().exec()}async function n(e,t){return await e.findOne(t).lean().exec()}async function o(e,t={},r={}){let{sort:s={createdAt:-1},limit:n=100,skip:a=0}=r;return await e.find(t).sort(s).skip(a).limit(n).lean().exec()}async function a(e,t,r,s={}){return await e.updateOne(t,r,s).exec()}async function i(e,t){return await e.deleteOne(t).exec()}async function c(e,t={}){return await e.countDocuments(t).exec()}r.d(t,{HO:()=>c,Vy:()=>o,Xg:()=>function e(t){if(!t)return t;if(Array.isArray(t))return t.map(t=>e(t));let r={...t};if(r._id){let e="object"==typeof r._id&&r._id.toString?r._id.toString():r._id;r.id||(r.id=e)}return r},fW:()=>n,kd:()=>i,mZ:()=>a,um:()=>s})},78335:()=>{},96487:()=>{},99493:(e,t,r)=>{"use strict";r.d(t,{P:()=>s,o:()=>n});var s=function(e){return e.GUIDE="guide",e.NEWS="news",e.TIPS="tips",e.ANALYSIS="analysis",e.MARKET="market",e.MEMES="memes",e.EXPERIENCE="experience",e}({}),n=function(e){return e.SWORD="sword",e.FIRE="fire",e.SHIELD="shield",e.CROWN="crown",e.CASTLE="castle",e.LAUGH="laugh",e}({})}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[7719,580],()=>r(63145));module.exports=s})();