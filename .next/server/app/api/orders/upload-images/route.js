(()=>{var e={};e.id=8926,e.ids=[8926],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},5385:(e,r,o)=>{"use strict";o.r(r),o.d(r,{patchFetch:()=>v,routeModule:()=>h,serverHooks:()=>$,workAsyncStorage:()=>q,workUnitAsyncStorage:()=>x});var t={};o.r(t),o.d(t,{POST:()=>S});var n=o(96559),s=o(48088),a=o(37719),i=o(32190),l=o(88839),c=o(31098),u=o(55511),d=o(29021),p=o.n(d),m=o(33873),g=o.n(m);let y=g().join(process.cwd(),"public","uploads");async function w(){try{p().existsSync(y)||await d.promises.mkdir(y,{recursive:!0})}catch(e){console.error("خطأ في إنشاء مجلد التخزين المحلي:",e)}}let f=async(e,r,o)=>{try{await w();let t=await e.arrayBuffer(),n=Buffer.from(t),s=(0,u.randomUUID)(),a=e.name.split(".").pop()||"jpg",i=`${o}_${s}.${a}`,l=g().join(y,r),c=g().join(l,i);p().existsSync(l)||await d.promises.mkdir(l,{recursive:!0}),await d.promises.writeFile(c,n);{let e=`/uploads/${r}/${i}`;return console.log(`تم حفظ الصورة في: ${c}`),console.log(`الرابط المحلي: ${e}`),e}}catch(e){throw console.error(`خطأ في رفع صورة ${o}:`,e),e}};async function S(e){try{await (0,l.A)();let r=await e.formData(),o=r.get("orderId"),t=r.get("coordImage"),n=r.get("nameImage");if(!o)return i.NextResponse.json({error:"معرف الطلب مطلوب"},{status:400});console.log(`جاري معالجة رفع الصور للطلب ${o}`),t&&console.log(`صورة الإحداثيات موجودة: ${t.name} (${t.size} bytes)`),n&&console.log(`صورة الاسم موجودة: ${n.name} (${n.size} bytes)`);let s=null,a=null;if(t&&(s=await f(t,o,"coord")),n&&(a=await f(n,o,"name")),!await c.A.findById(o))return i.NextResponse.json({error:`لم يتم العثور على الطلب بالمعرف: ${o}`},{status:404});let u=await c.A.updateOne({_id:o},{$set:{"images.coordImageUrl":s,"images.nameImageUrl":a,updatedAt:new Date}});return console.log(`نتيجة تحديث الطلب:`,u),i.NextResponse.json({success:!0,message:"تم رفع الصور بنجاح",orderId:o,images:{coordImageUrl:s,nameImageUrl:a}},{status:200})}catch(e){return console.error("خطأ أثناء رفع الصور:",e),i.NextResponse.json({error:"فشل رفع الصور"},{status:500})}}let h=new n.AppRouteRouteModule({definition:{kind:s.RouteKind.APP_ROUTE,page:"/api/orders/upload-images/route",pathname:"/api/orders/upload-images",filename:"route",bundlePath:"app/api/orders/upload-images/route"},resolvedPagePath:"C:\\Users\\minaa\\CascadeProjects\\conquerors-website\\src\\app\\api\\orders\\upload-images\\route.ts",nextConfigOutput:"",userland:t}),{workAsyncStorage:q,workUnitAsyncStorage:x,serverHooks:$}=h;function v(){return(0,a.patchFetch)({workAsyncStorage:q,workUnitAsyncStorage:x})}},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},29021:e=>{"use strict";e.exports=require("fs")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},31098:(e,r,o)=>{"use strict";o.d(r,{A:()=>a});var t=o(56037),n=o.n(t);let s=new t.Schema({orderNumber:{type:String,required:!0,unique:!0},customer:{name:{type:String,required:!0},email:{type:String,required:!0},phone:{type:String,required:!0},address:{type:String,required:!0},city:{type:String,required:!0},notes:{type:String},paymentMethod:{type:String,required:!1}},items:[{id:{type:String,required:!0},name:{type:String,required:!0},price:{type:Number,required:!0},icon:{type:String,required:!0},quantity:{type:Number,required:!0,min:1},category:{type:String,required:!0,enum:["resources","bots","castle","events","packages"]}}],totalPrice:{type:Number,required:!0},status:{type:String,required:!0,enum:["pending","processing","completed","canceled"],default:"pending"},images:{coordImageUrl:{type:String},nameImageUrl:{type:String}}},{timestamps:!0}),a=n().models.Order||n().model("Order",s)},33873:e=>{"use strict";e.exports=require("path")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:e=>{"use strict";e.exports=require("crypto")},56037:e=>{"use strict";e.exports=require("mongoose")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},78335:()=>{},88839:(e,r,o)=>{"use strict";o.d(r,{A:()=>c});var t=o(56037),n=o.n(t);let s=process.env.MONGODB_URI||"mongodb+srv://minaadelc4:cHjkStQnKuh91sNt@storefathone.a42qbk5.mongodb.net/storefathon?retryWrites=true&w=majority&appName=storefathone",a={connected:1,connecting:2},i=["منفصل","متصل","جاري الاتصال","جاري الانفصال"];if(!s)throw Error("يرجى تحديد رابط MONGODB_URI في ملف .env.local");let l=global.mongoose;l||(l=global.mongoose={conn:null,promise:null,errorCount:0,lastErrorTime:null});let c=async function(){if(l.conn)try{let e=l.conn.readyState;if(e===a.connected)return l.conn;console.log(`⚠️ حالة الاتصال بقاعدة البيانات غير صالحة (readyState=${e})، إعادة الاتصال...`),l.conn=null,l.promise=null}catch(e){console.error("❌ خطأ عند فحص حالة الاتصال الحالي:",e),l.conn=null,l.promise=null}if(l.lastErrorTime&&Date.now()-l.lastErrorTime>6e4&&(console.log("\uD83D\uDD04 إعادة ضبط عداد الأخطاء بعد مرور دقيقة"),l.errorCount=0,l.lastErrorTime=null),l.errorCount>5){let e=l.lastErrorTime?Math.floor((Date.now()-l.lastErrorTime)/1e3):0;if(console.error(`⛔ تجاوز الحد الأقصى لمحاولات الاتصال (${l.errorCount}). آخر محاولة منذ ${e} ثانية.`),e>60)console.log("\uD83D\uDD04 إعادة ضبط عداد محاولات الاتصال بعد فترة انتظار"),l.errorCount=0;else throw Error(`تجاوز الحد الأقصى لمحاولات الاتصال بقاعدة البيانات. حاول مرة أخرى لاحقًا (${Math.max(0,60-e)} ثانية متبقية)`)}l.promise?console.log("♻️ استخدام وعد اتصال موجود"):(console.log("\uD83D\uDD0D محاولة الاتصال بـ:",s.replace(/(mongodb\+srv:\/\/[^:]+):[^@]+@/,"$1:****@")),l.promise=n().connect(s,{bufferCommands:!0,serverSelectionTimeoutMS:2e4,connectTimeoutMS:2e4,socketTimeoutMS:6e4,family:4,maxPoolSize:10,retryWrites:!0,retryReads:!0}).then(e=>{let r=e.connection;return console.log(`🌿 تم الاتصال بقاعدة البيانات MongoDB بنجاح! (${r.name})`),r.on("error",e=>{console.error("❌ خطأ في اتصال قاعدة البيانات خلال التشغيل:",e)}),r.on("disconnected",()=>{console.warn("⚠️ انقطع الاتصال بقاعدة البيانات"),l.conn=null}),l.errorCount=0,l.lastErrorTime=null,r}).catch(e=>{throw l.errorCount++,l.lastErrorTime=Date.now(),console.error("❌ خطأ في الاتصال بقاعدة البيانات MongoDB:",e.message),"MongoServerSelectionError"===e.name&&(console.error("⚠️ خطأ اختيار السيرفر: تأكد من أن عنوان IP الخاص بك مسموح به في إعدادات الأمان لـ MongoDB Atlas"),console.error("\uD83D\uDCA1 اقتراح: اضبط Network Access في MongoDB Atlas للسماح لـ 0.0.0.0/0 للاختبار")),e.message.includes("Authentication failed")&&console.error("\uD83D\uDD11 فشل المصادقة: تأكد من صحة اسم المستخدم وكلمة المرور"),e.message.includes("getaddrinfo")&&console.error("\uD83C\uDF10 خطأ DNS: تأكد من اسم النطاق الصحيح وتوفر اتصال الإنترنت"),l.promise=null,e}));try{l.conn=await l.promise}catch(e){throw l.promise=null,e}let e=l.conn.readyState;if(e!==a.connected){console.warn(`⚠️ حالة الاتصال غير متوقعة: ${e}`);let r=i[e]||"غير معروفة";if(console.warn(`📊 حالة الاتصال: ${r}`),e===a.connecting){console.log("⏳ جاري الاتصال، الانتظار..."),await new Promise(e=>setTimeout(e,1e3));let e=l.conn.readyState;if(e===a.connected)console.log("✅ تم الاتصال بنجاح بعد الانتظار");else{let r=i[e]||"غير معروفة";console.warn(`⚠️ لا يزال الاتصال في حالة غير متوقعة: ${e} (${r})`)}}}return l.conn}},96487:()=>{}};var r=require("../../../../webpack-runtime.js");r.C(e);var o=e=>r(r.s=e),t=r.X(0,[7719,580],()=>o(5385));module.exports=t})();